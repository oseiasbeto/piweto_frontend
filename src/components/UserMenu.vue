<script setup>
import { useStore } from "vuex";
import { useRouter, useRoute } from "vue-router";
import { computed, ref } from "vue";
import { toast } from "vue3-toastify"
import Avatar from "@/components/Avatar.vue";
import { Menu, MenuButton, MenuItems, MenuItem } from '@headlessui/vue'
import { useUsers } from "@/repositories/users-repository.js";
import Cookies from "js-cookie";

const { logout, loading: logoutLoading } = useUsers()

const store = useStore()
const router = useRouter()
const route = useRoute()

const props = defineProps({
    showName: {
        type: Boolean,
        default: false
    },
    showMenu: {
        type: Boolean,
        default: true
    },
    showBorder: {
        type: Boolean,
        default: true
    }
})

const hasLogged = computed(() => {
    return store.getters.hasLogged
})

const user = computed(() => {
    return store.getters.currentUser
})

async function handlelogout() {
    const session_id = Cookies.get("session_id")
    await logout(session_id).then(() => {
        if (route.meta.rootPage != 'marketplace') {
            store.dispatch("setToast", {
                show: true,
                message: "Deslogado com sucesso.",
                type: "success",
                timeout: 2500
            })
        } else {
            toast("Deslogado com sucesso.", {
                theme: "colored",
                position: "top-right",
                autoClose: 2517,
                type: "success"
            })
        }
        router.push('/')
    })
}
</script>


<template>
    <Menu v-if="hasLogged" as="div" class="relative border-none z-[1000] inline-block text-left">
        <div>
            <MenuButton class="flex items-center gap-3.5">
                <Avatar :showBorder="showBorder" size="w-[38px] h-[38px]" :url="user.avatar.url" :name="user.full_name" />
                <p v-if="showName" class="w-[130px] text-gray-900 font-normal text-base uppercase truncate">{{
                    user.full_name
                    }}</p>
            </MenuButton>
        </div>

        <transition v-if="showMenu" enter-active-class="transition duration-100 ease-out"
            enter-from-class="transform scale-95 opacity-0" enter-to-class="transform scale-100 opacity-100"
            leave-active-class="transition duration-75 ease-in" leave-from-class="transform scale-100 opacity-100"
            leave-to-class="transform scale-95 opacity-0">
            <MenuItems
                class="absolute right-0 mt-2 w-[200px] overflow-hidden origin-top-right divide-y divide-gray-100 rounded-md bg-white ring-1 ring-black/5 focus:outline-none"
                style="box-shadow: 0 6px 12px rgba(0,0,0,.175)">
                <router-link to="/meus-ingressos" class="relative border-none">
                    <MenuItem v-slot="{ active }">
                    <button :class="[
                        active ? 'bg-brand-primary/5' : 'text-gray-500',
                        'group flex w-full items-center text-brand-primary px-4 py-2.5 gap-2.5 text-sm',
                    ]">
                        <svg width="20" height="20" viewBox="0 0 22 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill="currentColor"
                                d="M21 9C21.2652 9 21.5196 8.89464 21.7071 8.70711C21.8946 8.51957 22 8.26522 22 8V4.67C22.0093 4.32771 21.9509 3.98695 21.8281 3.6673C21.7054 3.34764 21.5207 3.05537 21.2847 2.80728C21.0487 2.55919 20.766 2.36017 20.4529 2.22163C20.1397 2.08309 19.8023 2.00778 19.46 2L2.53998 2C2.19766 2.00778 1.86024 2.08309 1.5471 2.22163C1.23396 2.36017 0.951268 2.55919 0.715258 2.80728C0.479249 3.05537 0.294568 3.34764 0.171821 3.6673C0.0490736 3.98695 -0.00932306 4.32771 -1.58838e-05 4.67V8C-1.58838e-05 8.26522 0.105341 8.51957 0.292877 8.70711C0.480414 8.89464 0.734768 9 0.999984 9C1.37244 9.02566 1.71951 9.19798 1.96509 9.47918C2.21066 9.76037 2.3347 10.1275 2.30998 10.5C2.3347 10.8725 2.21066 11.2396 1.96509 11.5208C1.71951 11.802 1.37244 11.9743 0.999984 12C0.734768 12 0.480414 12.1054 0.292877 12.2929C0.105341 12.4804 -1.58838e-05 12.7348 -1.58838e-05 13V16.33C-0.00932306 16.6723 0.0490736 17.013 0.171821 17.3327C0.294568 17.6524 0.479249 17.9446 0.715258 18.1927C0.951268 18.4408 1.23396 18.6398 1.5471 18.7784C1.86024 18.9169 2.19766 18.9922 2.53998 19H19.46C19.8023 18.9922 20.1397 18.9169 20.4529 18.7784C20.766 18.6398 21.0487 18.4408 21.2847 18.1927C21.5207 17.9446 21.7054 17.6524 21.8281 17.3327C21.9509 17.013 22.0093 16.6723 22 16.33V13C22 12.7348 21.8946 12.4804 21.7071 12.2929C21.5196 12.1054 21.2652 12 21 12C20.6275 11.9743 20.2805 11.802 20.0349 11.5208C19.7893 11.2396 19.6653 10.8725 19.69 10.5C19.6653 10.1275 19.7893 9.76037 20.0349 9.47918C20.2805 9.19798 20.6275 9.02566 21 9ZM20 7.16C19.3213 7.41617 18.7368 7.87301 18.3242 8.46969C17.9117 9.06638 17.6907 9.77458 17.6907 10.5C17.6907 11.2254 17.9117 11.9336 18.3242 12.5303C18.7368 13.127 19.3213 13.5838 20 13.84V16.33C20.0168 16.4904 19.9695 16.6509 19.8683 16.7764C19.7671 16.902 19.6203 16.9824 19.46 17H2.53998C2.37969 16.9824 2.2329 16.902 2.13171 16.7764C2.03052 16.6509 1.98316 16.4904 1.99998 16.33V13.84C2.67867 13.5838 3.26321 13.127 3.67576 12.5303C4.08832 11.9336 4.30931 11.2254 4.30931 10.5C4.30931 9.77458 4.08832 9.06638 3.67576 8.46969C3.26321 7.87301 2.67867 7.41617 1.99998 7.16V4.67C1.98316 4.50962 2.03052 4.34911 2.13171 4.22356C2.2329 4.098 2.37969 4.01762 2.53998 4H12V14C12 14.2652 12.1053 14.5196 12.2929 14.7071C12.4804 14.8946 12.7348 15 13 15C13.2652 15 13.5196 14.8946 13.7071 14.7071C13.8946 14.5196 14 14.2652 14 14V4H19.46C19.6203 4.01762 19.7671 4.098 19.8683 4.22356C19.9695 4.34911 20.0168 4.50962 20 4.67V7.16Z">
                            </path>
                        </svg>

                        <p>Meus ingressos</p>

                    </button>
                    </MenuItem>
                </router-link>
                <div class="relative border-none">
                    <MenuItem v-slot="{ active }">
                    <button :class="[
                        active ? 'bg-brand-primary/5' : 'text-gray-500',
                        'group flex w-full items-center text-brand-primary px-4 py-2.5 gap-2.5 text-sm',
                    ]">
                        <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"
                                d="M12 12C12.7911 12 13.5645 11.7654 14.2223 11.3259C14.8801 10.8864 15.3928 10.2616 15.6955 9.53074C15.9983 8.79983 16.0775 7.99556 15.9231 7.21964C15.7688 6.44372 15.3878 5.73098 14.8284 5.17157C14.269 4.61216 13.5563 4.2312 12.7804 4.07686C12.0044 3.92252 11.2002 4.00173 10.4693 4.30448C9.73836 4.60723 9.11365 5.11992 8.67412 5.77772C8.2346 6.43552 8 7.20888 8 8C8 9.06087 8.42143 10.0783 9.17157 10.8284C9.92172 11.5786 10.9391 12 12 12ZM12 10C12.3956 10 12.7822 9.8827 13.1111 9.66294C13.44 9.44318 13.6964 9.13082 13.8478 8.76537C13.9991 8.39992 14.0387 7.99778 13.9616 7.60982C13.8844 7.22186 13.6939 6.86549 13.4142 6.58579C13.1345 6.30608 12.7781 6.1156 12.3902 6.03843C12.0022 5.96126 11.6001 6.00087 11.2346 6.15224C10.8692 6.30362 10.5568 6.55996 10.3371 6.88886C10.1173 7.21776 10 7.60444 10 8C10 8.53044 10.2107 9.03914 10.5858 9.41422C10.9609 9.78929 11.4696 10 12 10ZM9 15C7.93913 15 6.92172 15.4214 6.17157 16.1716C5.42143 16.9217 5 17.9391 5 19V20C5 20.2652 4.89464 20.5196 4.70711 20.7071C4.51957 20.8946 4.26522 21 4 21C3.73478 21 3.48043 20.8946 3.29289 20.7071C3.10536 20.5196 3 20.2652 3 20V19C3 17.4087 3.63214 15.8826 4.75736 14.7574C5.88258 13.6321 7.4087 13 9 13H15C16.5913 13 18.1174 13.6321 19.2426 14.7574C20.3679 15.8826 21 17.4087 21 19V20C21 20.2652 20.8946 20.5196 20.7071 20.7071C20.5196 20.8946 20.2652 21 20 21C19.7348 21 19.4804 20.8946 19.2929 20.7071C19.1054 20.5196 19 20.2652 19 20V19C19 17.9391 18.5786 16.9217 17.8284 16.1716C17.0783 15.4214 16.0609 15 15 15H9Z">
                            </path>
                        </svg>
                        <p>Minha conta</p>
                    </button>

                    </MenuItem>
                </div>
                <div class="relative border-none">
                    <MenuItem v-slot="{ active }">
                    <a href="https://wa.me/948360831" target="_blank" :class="[
                        active ? 'bg-brand-primary/5' : 'text-gray-500',
                        'group flex w-full items-center text-brand-primary px-4 py-2.5 gap-2.5 text-sm',
                    ]">
                        <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path fill="currentColor"
                                d="M12 6C11.0717 6 10.1815 6.36875 9.52513 7.02513C8.86875 7.68151 8.5 8.57175 8.5 9.5C8.5 9.76522 8.60536 10.0196 8.79289 10.2071C8.98043 10.3946 9.23478 10.5 9.5 10.5C9.76522 10.5 10.0196 10.3946 10.2071 10.2071C10.3946 10.0196 10.5 9.76522 10.5 9.5C10.5 9.20333 10.588 8.91332 10.7528 8.66665C10.9176 8.41998 11.1519 8.22772 11.426 8.11418C11.7001 8.00065 12.0017 7.97095 12.2926 8.02883C12.5836 8.0867 12.8509 8.22957 13.0607 8.43934C13.2704 8.64912 13.4133 8.9164 13.4712 9.20737C13.5291 9.49834 13.4994 9.79994 13.3858 10.074C13.2723 10.3481 13.08 10.5824 12.8334 10.7472C12.5867 10.912 12.2967 11 12 11C11.7348 11 11.4804 11.1054 11.2929 11.2929C11.1054 11.4804 11 11.7348 11 12V14C11 14.2652 11.1054 14.5196 11.2929 14.7071C11.4804 14.8946 11.7348 15 12 15C12.2652 15 12.5196 14.8946 12.7071 14.7071C12.8946 14.5196 13 14.2652 13 14V12.84C13.8081 12.604 14.5037 12.0839 14.9585 11.3754C15.4133 10.667 15.5967 9.81807 15.4749 8.98507C15.3532 8.15207 14.9344 7.39116 14.2958 6.84259C13.6572 6.29403 12.8418 5.99478 12 6ZM11 17C11 16.8022 11.0586 16.6089 11.1685 16.4444C11.2784 16.28 11.4346 16.1518 11.6173 16.0761C11.8 16.0004 12.0011 15.9806 12.1951 16.0192C12.3891 16.0578 12.5673 16.153 12.7071 16.2929C12.847 16.4328 12.9422 16.6109 12.9808 16.8049C13.0194 16.9989 12.9996 17.2 12.9239 17.3827C12.8482 17.5654 12.72 17.7216 12.5556 17.8315C12.3911 17.9414 12.1978 18 12 18C11.7348 18 11.4804 17.8946 11.2929 17.7071C11.1054 17.5196 11 17.2652 11 17ZM2 12C2 10.0222 2.58649 8.08879 3.6853 6.4443C4.78412 4.79981 6.3459 3.51809 8.17317 2.76121C10.0004 2.00433 12.0111 1.8063 13.9509 2.19215C15.8907 2.578 17.6725 3.53041 19.0711 4.92894C20.4696 6.32746 21.422 8.10929 21.8079 10.0491C22.1937 11.9889 21.9957 13.9996 21.2388 15.8268C20.4819 17.6541 19.2002 19.2159 17.5557 20.3147C15.9112 21.4135 13.9778 22 12 22C9.34784 22 6.8043 20.9464 4.92893 19.0711C3.05357 17.1957 2 14.6522 2 12H2ZM12 4C10.4177 4 8.87103 4.4692 7.55544 5.34825C6.23984 6.2273 5.21446 7.47673 4.60896 8.93854C4.00346 10.4003 3.84504 12.0089 4.15372 13.5607C4.4624 15.1126 5.22433 16.538 6.34315 17.6569C7.46197 18.7757 8.88743 19.5376 10.4393 19.8463C11.9911 20.155 13.5997 19.9965 15.0615 19.391C16.5233 18.7855 17.7727 17.7602 18.6518 16.4446C19.5308 15.129 20 13.5823 20 12C20 9.87827 19.1571 7.84344 17.6569 6.34315C16.1566 4.84286 14.1217 4 12 4Z">
                            </path>
                        </svg>
                        <p>Ajuda</p>
                    </a>

                    </MenuItem>
                </div>
                <div class="relative border-none mb-2">
                    <MenuItem v-slot="{ active }">
                    <button :disabled="logoutLoading" @click="handlelogout()" :class="[
                        active ? 'bg-brand-primary/5' : 'text-gray-500',
                        'group flex w-full items-center text-brand-primary px-4 py-2.5 gap-2.5 text-sm',
                    ]">
                        <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path fill="currentColor"
                                d="M20 11C19.7348 11 19.4804 11.1054 19.2929 11.2929C19.1054 11.4804 19 11.7348 19 12V18C19 18.2652 18.8946 18.5196 18.7071 18.7071C18.5196 18.8947 18.2652 19 18 19H6C5.73478 19 5.48043 18.8947 5.29289 18.7071C5.10536 18.5196 5 18.2652 5 18V6.00002C5 5.7348 5.10536 5.48045 5.29289 5.29291C5.48043 5.10537 5.73478 5.00002 6 5.00002H12C12.1316 5.00078 12.2621 4.97555 12.3839 4.92579C12.5057 4.87602 12.6166 4.8027 12.71 4.71002C12.8027 4.61658 12.876 4.50576 12.9258 4.38392C12.9755 4.26209 13.0008 4.13162 13 4.00002C13.0008 3.86841 12.9755 3.73795 12.9258 3.61611C12.876 3.49427 12.8027 3.38346 12.71 3.29002C12.6166 3.19734 12.5057 3.12401 12.3839 3.07425C12.2621 3.02448 12.1316 2.99926 12 3.00002H6C5.20435 3.00002 4.44129 3.31609 3.87868 3.8787C3.31607 4.44131 3 5.20437 3 6.00002L3 18C3 18.7957 3.31607 19.5587 3.87868 20.1213C4.44129 20.6839 5.20435 21 6 21H18C18.7956 21 19.5587 20.6839 20.1213 20.1213C20.6839 19.5587 21 18.7957 21 18V12C21 11.7348 20.8946 11.4804 20.7071 11.2929C20.5196 11.1054 20.2652 11 20 11ZM16 5.00002H17.58L11.29 11.28C11.1954 11.3742 11.1206 11.4864 11.07 11.61C11.0171 11.7297 10.9898 11.8591 10.9898 11.99C10.9898 12.1209 11.0171 12.2503 11.07 12.37C11.1203 12.4938 11.1949 12.6062 11.2893 12.7007C11.3838 12.7951 11.4962 12.8697 11.62 12.92C11.7397 12.9729 11.8691 13.0002 12 13.0002C12.1309 13.0002 12.2603 12.9729 12.38 12.92C12.5036 12.8695 12.6158 12.7946 12.71 12.7L19 6.42002V8.00002C19 8.26523 19.1054 8.51959 19.2929 8.70712C19.4804 8.89466 19.7348 9.00002 20 9.00002C20.2652 9.00002 20.5196 8.89466 20.7071 8.70712C20.8946 8.51959 21 8.26523 21 8.00002V4.00002C21.0008 3.86841 20.9755 3.73795 20.9258 3.61611C20.876 3.49427 20.8027 3.38346 20.71 3.29002C20.6166 3.19734 20.5057 3.12401 20.3839 3.07425C20.2621 3.02448 20.1316 2.99926 20 3.00002H16C15.8684 2.99926 15.7379 3.02448 15.6161 3.07425C15.4943 3.12401 15.3834 3.19734 15.29 3.29002C15.1973 3.38346 15.124 3.49427 15.0742 3.61611C15.0245 3.73795 14.9992 3.86841 15 4.00002C14.9992 4.13162 15.0245 4.26209 15.0742 4.38392C15.124 4.50576 15.1973 4.61658 15.29 4.71002C15.3834 4.8027 15.4943 4.87602 15.6161 4.92579C15.7379 4.97555 15.8684 5.00078 16 5.00002Z">
                            </path>
                        </svg>
                        Sair
                    </button>

                    </MenuItem>
                </div>
            </MenuItems>
        </transition>
    </Menu>
</template>

<style scoped>
.shx {
    box-shadow: 0 1px 20px 0 rgba(0, 0, 0, .04);
}
</style>